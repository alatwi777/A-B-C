<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الاختبارات الإلكترونية</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            direction: rtl;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #1a5f7a;
            color: white;
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        header h1 {
            margin: 0;
            font-size: 1.8rem;
        }
        
        /* صفحة تسجيل الدخول */
        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }
        
        .login-form {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .login-form h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #1a5f7a;
        }
        
        .user-type-selector {
            display: flex;
            margin-bottom: 20px;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        
        .user-type-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .user-type-btn.active {
            background-color: #1a5f7a;
            color: white;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .form-group input:focus {
            border-color: #1a5f7a;
            outline: none;
        }
        
        .btn {
            background-color: #1a5f7a;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #0d4b63;
        }
        
        /* تبويبات المعلم */
        .teacher-tabs {
            display: flex;
            background-color: #1a5f7a;
            border-radius: 5px 5px 0 0;
            overflow: hidden;
        }
        
        .tab-btn {
            padding: 15px 25px;
            background-color: transparent;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .tab-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .tab-btn.active {
            background-color: white;
            color: #1a5f7a;
        }
        
        .tab-content {
            display: none;
            background-color: white;
            padding: 25px;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            min-height: 500px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* جداول البيانات */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #1a5f7a;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        /* ورقة التظليل */
        .shading-sheet {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .mcq-options {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .mcq-option {
            width: 23%;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .mcq-option.selected {
            background-color: #1a5f7a;
            color: white;
            border-color: #1a5f7a;
        }
        
        .true-false-options {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .true-false-btn {
            padding: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .true-false-btn.selected {
            background-color: #1a5f7a;
            color: white;
            border-color: #1a5f7a;
        }
        
        .essay-question {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        
        .essay-textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .essay-textarea:focus {
            border-color: #1a5f7a;
            outline: none;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .page-indicator {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
            color: #1a5f7a;
        }
        
        /* نموذج الطباعة */
        .print-preview {
            background-color: white;
            padding: 30px;
            border: 1px solid #ddd;
            margin-top: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #1a5f7a;
            padding-bottom: 15px;
        }
        
        .print-header h2 {
            margin: 0;
            color: #1a5f7a;
        }
        
        .print-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .print-actions {
            text-align: center;
            margin-top: 30px;
        }
        
        /* خيارات التصحيح */
        .grade-input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
        }
        
        .auto-correct-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
        }
        
        .message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .logout-btn {
            position: absolute;
            left: 20px;
            top: 20px;
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* تحسينات للاستجابة */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .mcq-option {
                width: 48%;
            }
            
            .teacher-tabs {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                flex: 1 0 50%;
                padding: 12px;
                font-size: 14px;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- صفحة تسجيل الدخول -->
        <div id="loginPage" class="login-page">
            <div class="container">
                <header>
                    <h1>نظام الاختبارات الإلكترونية</h1>
                </header>
                
                <div class="login-form">
                    <h2>تسجيل الدخول</h2>
                    
                    <div class="user-type-selector">
                        <div class="user-type-btn active" id="studentBtn">طالب</div>
                        <div class="user-type-btn" id="teacherBtn">معلم</div>
                    </div>
                    
                    <div id="loginForm">
                        <div class="form-group">
                            <label for="civilId" id="civilIdLabel">السجل المدني للطالب</label>
                            <input type="text" id="civilId" placeholder="أدخل السجل المدني">
                        </div>
                        
                        <div class="form-group">
                            <label for="testCode">كود الاختبار</label>
                            <input type="text" id="testCode" placeholder="أدخل كود الاختبار">
                        </div>
                        
                        <button class="btn" id="loginBtn">دخول</button>
                    </div>
                    
                    <div class="message" id="loginMessage"></div>
                </div>
            </div>
        </div>
        
        <!-- واجهة الطالب -->
        <div id="studentPage" style="display: none;">
            <div class="container">
                <header>
                    <h1>ورقة الاختبار - الطالب</h1>
                    <button class="logout-btn" id="studentLogoutBtn">تسجيل الخروج</button>
                </header>
                
                <div id="studentShadingSheet" class="shading-sheet">
                    <h2>اسم الطالب: <span id="studentName">أحمد محمد</span></h2>
                    <h3>المادة: <span id="studentSubject">الرياضيات</span></h3>
                    <h3>اللجنة: <span id="studentCommittee">لجنة التحكم والضبط</span></h3>
                    
                    <div class="page-indicator">ورقة الأسئلة 1 من 3</div>
                    
                    <h4>الأسئلة الاختيارية (أ ب ج د)</h4>
                    <div class="mcq-options" id="mcqQuestions">
                        <!-- سيتم إنشاء الأسئلة ديناميكيًا -->
                    </div>
                    
                    <h4>أسئلة الصح والخطأ</h4>
                    <div class="true-false-options" id="tfQuestions">
                        <!-- سيتم إنشاء الأسئلة ديناميكيًا -->
                    </div>
                    
                    <div class="essay-question">
                        <h4>السؤال المقالي</h4>
                        <p>اكتب مقالاً عن أهمية التعليم الإلكتروني في وقتنا الحالي (بحد أقصى 300 كلمة).</p>
                        <textarea class="essay-textarea" id="essayAnswer" placeholder="أدخل إجابتك هنا..."></textarea>
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="btn" id="prevPageBtn">الورقة السابقة</button>
                        <button class="btn" id="submitTestBtn">إنهاء الاختبار</button>
                        <button class="btn" id="nextPageBtn">الورقة التالية</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- واجهة المعلم -->
        <div id="teacherPage" style="display: none;">
            <div class="container">
                <header>
                    <h1>لوحة تحكم المعلم</h1>
                    <button class="logout-btn" id="teacherLogoutBtn">تسجيل الخروج</button>
                </header>
                
                <div class="teacher-tabs">
                    <button class="tab-btn active" data-tab="studentsData">بيانات الطالب</button>
                    <button class="tab-btn" data-tab="testInfo">معلومات الاختبار</button>
                    <button class="tab-btn" data-tab="results">النتائج</button>
                    <button class="tab-btn" data-tab="answerKey">مفتاح الإجابة</button>
                    <button class="tab-btn" data-tab="printPreview">نموذج الطباعة</button>
                </div>
                
                <!-- تبويب بيانات الطالب -->
                <div id="studentsData" class="tab-content active">
                    <h2>بيانات الطالب العامة</h2>
                    
                    <div class="form-group" style="display: flex; gap: 10px;">
                        <input type="text" id="addStudentName" placeholder="اسم الطالب">
                        <input type="text" id="addStudentGrade" placeholder="الصف">
                        <input type="text" id="addStudentCivilId" placeholder="السجل المدني">
                        <input type="text" id="addStudentCommittee" placeholder="اللجنة">
                        <button class="btn" id="addStudentBtn" style="width: auto;">إضافة طالب</button>
                    </div>
                    
                    <button class="btn" id="importExcelBtn" style="margin-bottom: 15px; width: auto;">استيراد من Excel</button>
                    
                    <table id="studentsTable">
                        <thead>
                            <tr>
                                <th>السجل المدني</th>
                                <th>الصف</th>
                                <th>اسم الطالب</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <!-- سيتم ملء البيانات ديناميكيًا -->
                        </tbody>
                    </table>
                </div>
                
                <!-- تبويب معلومات الاختبار -->
                <div id="testInfo" class="tab-content">
                    <h2>معلومات الاختبار</h2>
                    
                    <div class="form-group">
                        <label for="testName">اسم الاختبار</label>
                        <input type="text" id="testName" placeholder="أدخل اسم الاختبار">
                    </div>
                    
                    <div class="form-group">
                        <label for="testSubject">المادة</label>
                        <input type="text" id="testSubject" placeholder="أدخل المادة">
                    </div>
                    
                    <div class="form-group">
                        <label for="testDuration">زمن الاختبار (دقائق)</label>
                        <input type="number" id="testDuration" placeholder="أدخل زمن الاختبار">
                    </div>
                    
                    <div class="form-group">
                        <label for="testTeacher">اسم المعلم</label>
                        <input type="text" id="testTeacher" placeholder="أدخل اسم المعلم">
                    </div>
                    
                    <div class="form-group">
                        <label for="testCodeTeacher">كود الاختبار</label>
                        <input type="text" id="testCodeTeacher" placeholder="أدخل كود الاختبار">
                    </div>
                    
                    <div class="form-group">
                        <label for="questionType">نوع السؤال</label>
                        <select id="questionType" style="width: 100%; padding: 12px; border-radius: 5px;">
                            <option value="mcq">اختيار من متعدد</option>
                            <option value="tf">صح وخطأ</option>
                            <option value="essay">مقالي</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="questionsCount">عدد الفقرات</label>
                        <input type="number" id="questionsCount" placeholder="أدخل عدد الفقرات">
                    </div>
                    
                    <div class="form-group">
                        <label for="totalGrade">المجموع</label>
                        <input type="number" id="totalGrade" placeholder="المجموع الكلي">
                    </div>
                    
                    <div class="form-group">
                        <label for="gradePerQuestion">الدرجة لكل فقرة</label>
                        <input type="number" id="gradePerQuestion" placeholder="أدخل الدرجة لكل فقرة">
                    </div>
                    
                    <button class="btn" id="saveTestInfoBtn">حفظ معلومات الاختبار</button>
                    
                    <div class="message" id="testInfoMessage"></div>
                </div>
                
                <!-- تبويب النتائج -->
                <div id="results" class="tab-content">
                    <h2>النتائج</h2>
                    
                    <button class="auto-correct-btn" id="autoCorrectBtn">تصحيح تلقائي للأسئلة الموضوعية</button>
                    
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>اسم الطالب</th>
                                <th>السجل المدني</th>
                                <th>الدرجة</th>
                                <th>تصحيح المقالي</th>
                                <th>معاينة</th>
                                <th>طباعة</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- سيتم ملء البيانات ديناميكيًا -->
                        </tbody>
                    </table>
                </div>
                
                <!-- تبويب مفتاح الإجابة -->
                <div id="answerKey" class="tab-content">
                    <h2>مفتاح الإجابة للمعلم</h2>
                    <p>هنا يمكنك تعيين الإجابات الصحيحة للأسئلة ليتم التصحيح التلقائي بناءً عليها.</p>
                    
                    <div id="teacherShadingSheet" class="shading-sheet">
                        <h3>الإجابات الصحيحة للأسئلة الاختيارية</h3>
                        <div class="mcq-options" id="teacherMcqKey">
                            <!-- سيتم إنشاء مفتاح الإجابة ديناميكيًا -->
                        </div>
                        
                        <h3>الإجابات الصحيحة لأسئلة الصح والخطأ</h3>
                        <div class="true-false-options" id="teacherTfKey">
                            <!-- سيتم إنشاء مفتاح الإجابة ديناميكيًا -->
                        </div>
                        
                        <div class="essay-question">
                            <h3>السؤال المقالي</h3>
                            <p>يتم تصحيح السؤال المقالي يدوياً من قبل المعلم في تبويب النتائج.</p>
                        </div>
                        
                        <button class="btn" id="saveAnswerKeyBtn">حفظ مفتاح الإجابة</button>
                        <div class="message" id="answerKeyMessage"></div>
                    </div>
                </div>
                
                <!-- تبويب نموذج الطباعة -->
                <div id="printPreview" class="tab-content">
                    <h2>نموذج الطباعة</h2>
                    
                    <div class="print-actions">
                        <button class="btn" id="generatePrintBtn" style="width: auto;">إنشاء نموذج طباعة</button>
                        <button class="btn" id="printBtn" style="width: auto; background-color: #28a745;">طباعة</button>
                    </div>
                    
                    <div class="print-preview" id="printContent">
                        <div class="print-header">
                            <h2>المملكة العربية السعودية</h2>
                            <h3>إدارة تعليم تبوك</h3>
                            <h3>متوسطة الحسين بن علي</h3>
                        </div>
                        
                        <div class="print-info">
                            <div>
                                <p><strong>اسم الطالب:</strong> <span id="printStudentName">أحمد محمد</span></p>
                                <p><strong>المادة:</strong> <span id="printSubject">الرياضيات</span></p>
                            </div>
                            <div>
                                <p><strong>اسم الاختبار:</strong> <span id="printTestName">الاختبار النصفي</span></p>
                                <p><strong>تاريخ الاختبار:</strong> <span id="printTestDate">١٤٤٥/٠٦/٢٠</span></p>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin: 40px 0;">
                            <h3>هنا تكون ورقة إجابات الطالب مصححة</h3>
                            <p>الدرجة الكلية: <span id="printTotalGrade" style="font-weight: bold; font-size: 24px;">85</span> / 100</p>
                        </div>
                        
                        <div>
                            <h4>التفاصيل:</h4>
                            <p>الأسئلة الاختيارية: <span id="printMcqScore">45</span> / 50</p>
                            <p>أسئلة الصح والخطأ: <span id="printTfScore">20</span> / 30</p>
                            <p>السؤال المقالي: <span id="printEssayScore">20</span> / 20</p>
                        </div>
                        
                        <div style="margin-top: 40px; text-align: left;">
                            <p>توقيع المعلم: ________________</p>
                            <p>تاريخ التصحيح: <span id="printCorrectionDate">١٤٤٥/٠٦/٢١</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC8xgOK6q1ADVI1TnOMGDZ6oX6kfi5xKfg",
           authDomain: "kkkk-b7d29.firebaseapp.com",
           projectId: "kkkk-b7d29",
          storageBucket: "kkkk-b7d29.firebasestorage.app",
          messagingSenderId: "302362191771",
          appId: "1:302362191771:web:5d68cb250f7e2e5195e33e",
          measurementId: "G-QK0B5XQ3XD
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const analytics = firebase.analytics();
        
        // حالات التطبيق
        const appState = {
            currentUser: null,
            userType: null, // 'student' أو 'teacher'
            testData: null,
            studentAnswers: {},
            answerKey: {},
            currentPage: 1,
            totalPages: 3
        };
        
        // بيانات تجريبية للطلاب
        const sampleStudents = [
            { id: 1, name: "أحمد محمد", grade: "الثاني ثانوي", civilId: "1234567890", committee: "لجنة التحكم والضبط" },
            { id: 2, name: "فاطمة عبدالله", grade: "الثاني ثانوي", civilId: "0987654321", committee: "لجنة التحكم والضبط" },
            { id: 3, name: "خالد سعيد", grade: "الأول ثانوي", civilId: "1122334455", committee: "لجنة التحكم والضبط" },
            { id: 4, name: "سارة علي", grade: "الثالث ثانوي", civilId: "5566778899", committee: "لجنة التحكم والضبط" },
            { id: 5, name: "محمد حسن", grade: "الثاني ثانوي", civilId: "6677889900", committee: "لجنة التحكم والضبط" }
        ];
        
        // بيانات تجريبية للنتائج
        const sampleResults = [
            { studentName: "أحمد محمد", civilId: "1234567890", grade: 85, essayGrade: 20, mcqScore: 45, tfScore: 20 },
            { studentName: "فاطمة عبدالله", civilId: "0987654321", grade: 92, essayGrade: 22, mcqScore: 48, tfScore: 22 },
            { studentName: "خالد سعيد", civilId: "1122334455", grade: 78, essayGrade: 18, mcqScore: 40, tfScore: 20 },
            { studentName: "سارة علي", civilId: "5566778899", grade: 95, essayGrade: 25, mcqScore: 50, tfScore: 20 },
            { studentName: "محمد حسن", civilId: "6677889900", grade: 88, essayGrade: 20, mcqScore: 48, tfScore: 20 }
        ];
        
        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        
        function initApp() {
            // عناصر واجهة المستخدم
            const studentBtn = document.getElementById('studentBtn');
            const teacherBtn = document.getElementById('teacherBtn');
            const loginBtn = document.getElementById('loginBtn');
            const civilIdInput = document.getElementById('civilId');
            const testCodeInput = document.getElementById('testCode');
            const civilIdLabel = document.getElementById('civilIdLabel');
            const loginMessage = document.getElementById('loginMessage');
            
            const studentLogoutBtn = document.getElementById('studentLogoutBtn');
            const teacherLogoutBtn = document.getElementById('teacherLogoutBtn');
            
            const teacherTabs = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            const addStudentBtn = document.getElementById('addStudentBtn');
            const importExcelBtn = document.getElementById('importExcelBtn');
            const saveTestInfoBtn = document.getElementById('saveTestInfoBtn');
            const autoCorrectBtn = document.getElementById('autoCorrectBtn');
            const saveAnswerKeyBtn = document.getElementById('saveAnswerKeyBtn');
            const generatePrintBtn = document.getElementById('generatePrintBtn');
            const printBtn = document.getElementById('printBtn');
            
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const submitTestBtn = document.getElementById('submitTestBtn');
            
            // تبديل نوع المستخدم (طالب/معلم)
            studentBtn.addEventListener('click', function() {
                studentBtn.classList.add('active');
                teacherBtn.classList.remove('active');
                civilIdLabel.textContent = "السجل المدني للطالب";
                civilIdInput.placeholder = "أدخل السجل المدني";
            });
            
            teacherBtn.addEventListener('click', function() {
                teacherBtn.classList.add('active');
                studentBtn.classList.remove('active');
                civilIdLabel.textContent = "السجل المدني للمعلم";
                civilIdInput.placeholder = "أدخل ١٢٣٤";
            });
            
            // تسجيل الدخول
            loginBtn.addEventListener('click', function() {
                const civilId = civilIdInput.value.trim();
                const testCode = testCodeInput.value.trim();
                
                if (!civilId || !testCode) {
                    showMessage(loginMessage, "يرجى ملء جميع الحقول", "error");
                    return;
                }
                
                // محاكاة تسجيل الدخول
                if (studentBtn.classList.contains('active')) {
                    // تسجيل دخول الطالب
                    if (civilId.length >= 8 && testCode.length >= 2) {
                        appState.currentUser = { type: 'student', civilId: civilId };
                        appState.userType = 'student';
                        
                        // تعيين بيانات تجريبية
                        const student = sampleStudents.find(s => s.civilId === civilId) || sampleStudents[0];
                        document.getElementById('studentName').textContent = student.name;
                        document.getElementById('studentSubject').textContent = "الرياضيات";
                        document.getElementById('studentCommittee').textContent = student.committee;
                        
                        // تهيئة ورقة التظليل للطالب
                        initStudentShadingSheet();
                        
                        // الانتقال لواجهة الطالب
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('studentPage').style.display = 'block';
                        
                        showMessage(loginMessage, "تم تسجيل الدخول بنجاح كطالب", "success");
                    } else {
                        showMessage(loginMessage, "السجل المدني أو كود الاختبار غير صحيح", "error");
                    }
                } else {
                    // تسجيل دخول المعلم
                    if (civilId === "1234" && testCode === "200") {
                        appState.currentUser = { type: 'teacher', civilId: civilId };
                        appState.userType = 'teacher';
                        
                        // تهيئة واجهة المعلم
                        initTeacherInterface();
                        
                        // الانتقال لواجهة المعلم
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('teacherPage').style.display = 'block';
                        
                        showMessage(loginMessage, "تم تسجيل الدخول بنجاح كمعلم", "success");
                    } else {
                        showMessage(loginMessage, "بيانات المعلم غير صحيحة. استخدم ١٢٣٤ و ٢٠٠", "error");
                    }
                }
            });
            
            // تسجيل الخروج للطالب
            studentLogoutBtn.addEventListener('click', function() {
                appState.currentUser = null;
                appState.userType = null;
                document.getElementById('studentPage').style.display = 'none';
                document.getElementById('loginPage').style.display = 'block';
                civilIdInput.value = "";
                testCodeInput.value = "";
                loginMessage.style.display = 'none';
            });
            
            // تسجيل الخروج للمعلم
            teacherLogoutBtn.addEventListener('click', function() {
                appState.currentUser = null;
                appState.userType = null;
                document.getElementById('teacherPage').style.display = 'none';
                document.getElementById('loginPage').style.display = 'block';
                civilIdInput.value = "";
                testCodeInput.value = "";
                loginMessage.style.display = 'none';
            });
            
            // إدارة تبويبات المعلم
            teacherTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // إزالة النشاط من جميع التبويبات
                    teacherTabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // إضافة النشاط للتبويب المحدد
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // إضافة طالب جديد
            addStudentBtn.addEventListener('click', function() {
                const name = document.getElementById('addStudentName').value.trim();
                const grade = document.getElementById('addStudentGrade').value.trim();
                const civilId = document.getElementById('addStudentCivilId').value.trim();
                const committee = document.getElementById('addStudentCommittee').value.trim();
                
                if (!name || !grade || !civilId || !committee) {
                    alert("يرجى ملء جميع بيانات الطالب");
                    return;
                }
                
                // إضافة الطالب للجدول
                const tableBody = document.getElementById('studentsTableBody');
                const newRow = document.createElement('tr');
                
                newRow.innerHTML = `
                    <td>${civilId}</td>
                    <td>${grade}</td>
                    <td>${name}</td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; background-color: #28a745;">تعديل</button>
                        <button class="btn" style="padding: 5px 10px; background-color: #dc3545;">حذف</button>
                    </td>
                `;
                
                tableBody.appendChild(newRow);
                
                // مسح الحقول
                document.getElementById('addStudentName').value = "";
                document.getElementById('addStudentGrade').value = "";
                document.getElementById('addStudentCivilId').value = "";
                document.getElementById('addStudentCommittee').value = "";
                
                alert("تمت إضافة الطالب بنجاح");
            });
            
            // استيراد من Excel
            importExcelBtn.addEventListener('click', function() {
                alert("سيتم استيراد بيانات الطلاب من ملف Excel. هذه الميزة تتطلب تكامل مع Firebase Storage.");
            });
            
            // حفظ معلومات الاختبار
            saveTestInfoBtn.addEventListener('click', function() {
                const testName = document.getElementById('testName').value.trim();
                const testSubject = document.getElementById('testSubject').value.trim();
                const testDuration = document.getElementById('testDuration').value.trim();
                const testTeacher = document.getElementById('testTeacher').value.trim();
                const testCodeTeacher = document.getElementById('testCodeTeacher').value.trim();
                
                if (!testName || !testSubject || !testDuration || !testTeacher || !testCodeTeacher) {
                    showMessage(document.getElementById('testInfoMessage'), "يرجى ملء جميع الحقول", "error");
                    return;
                }
                
                appState.testData = {
                    name: testName,
                    subject: testSubject,
                    duration: testDuration,
                    teacher: testTeacher,
                    code: testCodeTeacher
                };
                
                showMessage(document.getElementById('testInfoMessage'), "تم حفظ معلومات الاختبار بنجاح", "success");
            });
            
            // التصحيح التلقائي
            autoCorrectBtn.addEventListener('click', function() {
                alert("تم تصحيح الأسئلة الموضوعية تلقائياً بناءً على مفتاح الإجابة.");
                
                // محاكاة التصحيح التلقائي
                const resultsBody = document.getElementById('resultsTableBody');
                resultsBody.innerHTML = '';
                
                sampleResults.forEach(result => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${result.studentName}</td>
                        <td>${result.civilId}</td>
                        <td>${result.grade}</td>
                        <td>
                            <input type="number" class="grade-input" value="${result.essayGrade}" min="0" max="25">
                            <button class="btn" style="padding: 5px 10px; margin-right: 5px;">حفظ</button>
                        </td>
                        <td><button class="btn" style="padding: 5px 10px; background-color: #17a2b8;">معاينة</button></td>
                        <td><button class="btn" style="padding: 5px 10px; background-color: #ffc107;">طباعة</button></td>
                    `;
                    
                    resultsBody.appendChild(row);
                });
            });
            
            // حفظ مفتاح الإجابة
            saveAnswerKeyBtn.addEventListener('click', function() {
                // جمع الإجابات الصحيحة
                const mcqAnswers = [];
                const mcqOptions = document.querySelectorAll('#teacherMcqKey .mcq-option.selected');
                mcqOptions.forEach(option => {
                    mcqAnswers.push(option.textContent.trim());
                });
                
                const tfAnswers = [];
                const tfOptions = document.querySelectorAll('#teacherTfKey .true-false-btn.selected');
                tfOptions.forEach(option => {
                    tfAnswers.push(option.textContent.trim() === 'صح' ? true : false);
                });
                
                appState.answerKey = {
                    mcq: mcqAnswers,
                    trueFalse: tfAnswers
                };
                
                showMessage(document.getElementById('answerKeyMessage'), "تم حفظ مفتاح الإجابة بنجاح", "success");
                console.log("مفتاح الإجابة المحفوظ:", appState.answerKey);
            });
            
            // إنشاء نموذج الطباعة
            generatePrintBtn.addEventListener('click', function() {
                // تعيين البيانات في نموذج الطباعة
                document.getElementById('printStudentName').textContent = sampleResults[0].studentName;
                document.getElementById('printSubject').textContent = appState.testData ? appState.testData.subject : "الرياضيات";
                document.getElementById('printTestName').textContent = appState.testData ? appState.testData.name : "الاختبار النصفي";
                document.getElementById('printTestDate').textContent = new Date().toLocaleDateString('ar-SA');
                document.getElementById('printTotalGrade').textContent = sampleResults[0].grade;
                document.getElementById('printMcqScore').textContent = sampleResults[0].mcqScore;
                document.getElementById('printTfScore').textContent = sampleResults[0].tfScore;
                document.getElementById('printEssayScore').textContent = sampleResults[0].essayGrade;
                document.getElementById('printCorrectionDate').textContent = new Date().toLocaleDateString('ar-SA');
                
                alert("تم إنشاء نموذج الطباعة بنجاح");
            });
            
            // طباعة النموذج
            printBtn.addEventListener('click', function() {
                window.print();
            });
            
            // التنقل بين صفحات الاختبار للطالب
            prevPageBtn.addEventListener('click', function() {
                if (appState.currentPage > 1) {
                    appState.currentPage--;
                    updatePageIndicator();
                }
            });
            
            nextPageBtn.addEventListener('click', function() {
                if (appState.currentPage < appState.totalPages) {
                    appState.currentPage++;
                    updatePageIndicator();
                }
            });
            
            // إنهاء الاختبار
            submitTestBtn.addEventListener('click', function() {
                if (confirm("هل أنت متأكد من إنهاء الاختبار؟ لا يمكنك العودة بعد الإنهاء.")) {
                    alert("تم إرسال الاختبار بنجاح. سيتم تصحيح الأسئلة الموضوعية تلقائياً.");
                    
                    // هنا يمكن إضافة منطق إرسال الإجابات إلى Firebase
                    
                    // العودة إلى صفحة تسجيل الدخول
                    studentLogoutBtn.click();
                }
            });
            
            // تهيئة واجهة المعلم
            function initTeacherInterface() {
                // تعبئة جدول الطلاب
                const studentsTableBody = document.getElementById('studentsTableBody');
                studentsTableBody.innerHTML = '';
                
                sampleStudents.forEach(student => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${student.civilId}</td>
                        <td>${student.grade}</td>
                        <td>${student.name}</td>
                        <td>
                            <button class="btn" style="padding: 5px 10px; background-color: #28a745;">تعديل</button>
                            <button class="btn" style="padding: 5px 10px; background-color: #dc3545;">حذف</button>
                        </td>
                    `;
                    
                    studentsTableBody.appendChild(row);
                });
                
                // تعبئة جدول النتائج
                const resultsTableBody = document.getElementById('resultsTableBody');
                resultsTableBody.innerHTML = '';
                
                sampleResults.forEach(result => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${result.studentName}</td>
                        <td>${result.civilId}</td>
                        <td>${result.grade}</td>
                        <td>
                            <input type="number" class="grade-input" value="${result.essayGrade}" min="0" max="25">
                            <button class="btn" style="padding: 5px 10px; margin-right: 5px;">حفظ</button>
                        </td>
                        <td><button class="btn" style="padding: 5px 10px; background-color: #17a2b8;">معاينة</button></td>
                        <td><button class="btn" style="padding: 5px 10px; background-color: #ffc107;">طباعة</button></td>
                    `;
                    
                    resultsTableBody.appendChild(row);
                });
                
                // تهيئة مفتاح الإجابة
                initAnswerKey();
            }
            
            // تهيئة مفتاح الإجابة
            function initAnswerKey() {
                // إنشاء 25 سؤال اختياري
                const mcqContainer = document.getElementById('teacherMcqKey');
                mcqContainer.innerHTML = '';
                
                for (let i = 1; i <= 25; i++) {
                    const option = document.createElement('div');
                    option.className = 'mcq-option';
                    option.textContent = ['أ', 'ب', 'ج', 'د'][Math.floor(Math.random() * 4)];
                    option.dataset.questionId = i;
                    
                    option.addEventListener('click', function() {
                        // إلغاء تحديد الخيارات الأخرى لنفس السؤال
                        const allOptions = mcqContainer.querySelectorAll(`.mcq-option[data-question-id="${i}"]`);
                        allOptions.forEach(opt => opt.classList.remove('selected'));
                        
                        // تحديد الخيار الحالي
                        this.classList.add('selected');
                    });
                    
                    mcqContainer.appendChild(option);
                }
                
                // إنشاء 60 سؤال صح/خطأ
                const tfContainer = document.getElementById('teacherTfKey');
                tfContainer.innerHTML = '';
                
                for (let i = 1; i <= 60; i++) {
                    const trueBtn = document.createElement('div');
                    trueBtn.className = 'true-false-btn';
                    trueBtn.textContent = 'صح';
                    trueBtn.dataset.questionId = i;
                    trueBtn.dataset.answer = 'true';
                    
                    const falseBtn = document.createElement('div');
                    falseBtn.className = 'true-false-btn';
                    falseBtn.textContent = 'خطأ';
                    falseBtn.dataset.questionId = i;
                    falseBtn.dataset.answer = 'false';
                    
                    trueBtn.addEventListener('click', function() {
                        const falseBtn = tfContainer.querySelector(`.true-false-btn[data-question-id="${i}"][data-answer="false"]`);
                        falseBtn.classList.remove('selected');
                        this.classList.add('selected');
                    });
                    
                    falseBtn.addEventListener('click', function() {
                        const trueBtn = tfContainer.querySelector(`.true-false-btn[data-question-id="${i}"][data-answer="true"]`);
                        trueBtn.classList.remove('selected');
                        this.classList.add('selected');
                    });
                    
                    tfContainer.appendChild(trueBtn);
                    tfContainer.appendChild(falseBtn);
                }
            }
            
            // تهيئة ورقة التظليل للطالب
            function initStudentShadingSheet() {
                // إنشاء 25 سؤال اختياري
                const mcqContainer = document.getElementById('mcqQuestions');
                mcqContainer.innerHTML = '';
                
                for (let i = 1; i <= 25; i++) {
                    const option = document.createElement('div');
                    option.className = 'mcq-option';
                    option.textContent = ['أ', 'ب', 'ج', 'د'][Math.floor(Math.random() * 4)];
                    option.dataset.questionId = i;
                    
                    option.addEventListener('click', function() {
                        // إلغاء تحديد الخيارات الأخرى لنفس السؤال
                        const allOptions = mcqContainer.querySelectorAll(`.mcq-option[data-question-id="${i}"]`);
                        allOptions.forEach(opt => opt.classList.remove('selected'));
                        
                        // تحديد الخيار الحالي
                        this.classList.add('selected');
                        
                        // حفظ الإجابة
                        if (!appState.studentAnswers[i]) appState.studentAnswers[i] = {};
                        appState.studentAnswers[i].mcq = this.textContent;
                    });
                    
                    mcqContainer.appendChild(option);
                }
                
                // إنشاء 60 سؤال صح/خطأ
                const tfContainer = document.getElementById('tfQuestions');
                tfContainer.innerHTML = '';
                
                for (let i = 1; i <= 60; i++) {
                    const trueBtn = document.createElement('div');
                    trueBtn.className = 'true-false-btn';
                    trueBtn.textContent = 'صح';
                    trueBtn.dataset.questionId = i;
                    trueBtn.dataset.answer = 'true';
                    
                    const falseBtn = document.createElement('div');
                    falseBtn.className = 'true-false-btn';
                    falseBtn.textContent = 'خطأ';
                    falseBtn.dataset.questionId = i;
                    falseBtn.dataset.answer = 'false';
                    
                    trueBtn.addEventListener('click', function() {
                        const falseBtn = tfContainer.querySelector(`.true-false-btn[data-question-id="${i}"][data-answer="false"]`);
                        falseBtn.classList.remove('selected');
                        this.classList.add('selected');
                        
                        // حفظ الإجابة
                        if (!appState.studentAnswers[i]) appState.studentAnswers[i] = {};
                        appState.studentAnswers[i].trueFalse = true;
                    });
                    
                    falseBtn.addEventListener('click', function() {
                        const trueBtn = tfContainer.querySelector(`.true-false-btn[data-question-id="${i}"][data-answer="true"]`);
                        trueBtn.classList.remove('selected');
                        this.classList.add('selected');
                        
                        // حفظ الإجابة
                        if (!appState.studentAnswers[i]) appState.studentAnswers[i] = {};
                        appState.studentAnswers[i].trueFalse = false;
                    });
                    
                    tfContainer.appendChild(trueBtn);
                    tfContainer.appendChild(falseBtn);
                }
                
                // حفظ إجابة السؤال المقالي
                const essayTextarea = document.getElementById('essayAnswer');
                essayTextarea.addEventListener('input', function() {
                    appState.studentAnswers.essay = this.value;
                });
                
                updatePageIndicator();
            }
            
            // تحديث مؤشر الصفحة
            function updatePageIndicator() {
                document.querySelector('.page-indicator').textContent = `ورقة الأسئلة ${appState.currentPage} من ${appState.totalPages}`;
            }
            
            // عرض رسائل للمستخدم
            function showMessage(element, text, type) {
                element.textContent = text;
                element.className = 'message ' + (type === 'success' ? 'success-message' : 'error-message');
                element.style.display = 'block';
                
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>
